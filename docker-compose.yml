version: '3.8'

services:
  # ==========================================
  # INFRAESTRUTURA & DASHBOARD
  # ==========================================

  # --- DASHBOARD (Página Inicial) ---
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    restart: unless-stopped
    ports:
      - "80:3000" # Porta 80 = Acesso direto pelo IP do servidor
    environment:
      - HOMEPAGE_ALLOWED_HOSTS=*
      - TZ=${TZ:-America/Sao_Paulo}
    volumes:
      - ./configs/homepage:/app/config
      - ./configs/homepage/images:/app/public/images
      - ./configs/homepage/icons:/app/public/icons
      # Socket do Docker (necessário para o Homepage ler o status dos containers)
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # --- MONITORAMENTO (Glances) ---
  glances:
    image: nicolargo/glances:latest
    container_name: glances
    restart: unless-stopped
    pid: host
    ports:
      - "61208:61208"
    environment:
      - GLANCES_OPT=-w
      - TZ=${TZ:-America/Sao_Paulo}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # --- GERENCIADOR DE ARQUIVOS WEB (FileBrowser) ---
  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: filebrowser
    restart: unless-stopped
    ports:
      - "8085:80"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    volumes:
      - ${DATA_PATH}:/srv
      - ./configs/filebrowser/filebrowser.db:/database/filebrowser.db
  # ==========================================
  # DESENVOLVIMENTO (IA)
  # ==========================================

  # --- BACKEND DE IA (Ollama) ---
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_ORIGINS=*
    volumes:
      - ollama_data:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # --- INTERFACE (Open WebUI) ---
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "3000:8080"
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      # A chave secreta vem do .env
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY}
      - CORS_ALLOW_ORIGIN=*
    volumes:
      - open-webui_data:/app/backend/data
    depends_on:
      - ollama

  # --- ESTUDOS & VISÃO COMPUTACIONAL (Jupyter/Colab Local) ---
  colab-local:
    image: us-docker.pkg.dev/colab-images/public/runtime
    container_name: colab-local
    restart: unless-stopped
    ports:
      - "8899:8080"
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      # Os notebooks ficam organizados dentro do storage
      - ${DATA_PATH}/study:/content
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # --- GERAÇÃO DE IMAGENS (Fooocus) ---
  fooocus:
    # Apontando para a estrutura de pastas do repositório
    build: ./builds/fooocus
    container_name: fooocus
    restart: unless-stopped
    ipc: host
    ports:
      - "7865:7865"
    environment:
      - CMDARGS=--listen
      - DATADIR=/content/data
    volumes:
      # Modelos e outputs dinâmicos, isolados da configuração local do seu SO
      - ${DATA_PATH}/fooocus/models:/content/data/models
      - ${DATA_PATH}/fooocus/outputs:/content/data/outputs
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
  # ==========================================
  # MÍDIA, ÁUDIO & FOTOS
  # ==========================================

  # --- ENTRETENIMENTO (Jellyfin) ---
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    ports:
      - "8096:8096"
    environment:
      - TZ=${TZ:-America/Sao_Paulo}
    volumes:
      - ./configs/jellyfin:/config
      - jellyfin_cache:/cache
      # Apontando para a pasta geral de mídias definida no env
      - ${DATA_PATH}/media:/media
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu, video] # Mantém NVENC para transcodificação acelerada

  # --- STREAMING DE MÚSICA (Navidrome) ---
  navidrome:
    image: deluan/navidrome:latest
    container_name: navidrome
    restart: unless-stopped
    ports:
      - "4533:4533"
    environment:
      - ND_SCANSCHEDULE=1m 
      - ND_LOGLEVEL=info
      - ND_SESSIONTIMEOUT=24h
      - ND_DEFAULTTHEME=Spotify-ish
    volumes:
      - ./configs/navidrome:/data
      # Apenas leitura para as músicas
      - ${DATA_PATH}/media/musicas:/music:ro

  # --- ORGANIZADOR DE MÚSICAS (MusicBrainz Picard) ---
  picard:
    image: jlesage/musicbrainz-picard:latest
    container_name: picard
    restart: unless-stopped
    ports:
      - "5800:5800"
    environment:
      - USER_ID=${PUID:-1000}
      - GROUP_ID=${PGID:-1000}
      - TZ=${TZ:-America/Sao_Paulo}
    volumes:
      - ./configs/picard:/config
      # Escrita liberada para organizar os metadados
      - ${DATA_PATH}/media/musicas:/storage:rw

  # --- GALERIA DE FOTOS (Immich) ---
  immich-server:
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-v2}
    container_name: immich_server
    command: ['start.sh', 'immich']
    restart: always
    ports:
      - "2283:2283"
    environment:
      - HOST=0.0.0.0
      - DB_HOSTNAME=immich_postgres
      - REDIS_HOSTNAME=immich_redis
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE_NAME=${DB_DATABASE_NAME}
    volumes:
      # Caminho definido no .env
      - ${UPLOAD_LOCATION}:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - immich-redis
      - immich-postgres

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release-cuda
    container_name: immich_machine_learning
    restart: always
    environment:
      - DB_HOSTNAME=immich_postgres
      - REDIS_HOSTNAME=immich_redis
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE_NAME=${DB_DATABASE_NAME}
    volumes:
      - immich_model_cache:/cache
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  immich-redis:
    image: redis:6.2-alpine
    container_name: immich_redis
    restart: always

  immich-postgres:
    image: tensorchord/pgvecto-rs:pg14-v0.2.0
    container_name: immich_postgres
    restart: always
    environment:
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_DB=${DB_DATABASE_NAME}
      - POSTGRES_INITDB_ARGS=--data-checksums
    volumes:
      # Isolando o banco de dados do Immich dentro do DATA_PATH
      - ${DATA_PATH}/immich/postgres:/var/lib/postgresql/data
