version: '3.8'

services:
  # ==========================================
  # INFRAESTRUTURA & DASHBOARD
  # ==========================================

  # --- DASHBOARD (Página Inicial) ---
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    restart: unless-stopped
    ports:
      - "80:3000" # Porta 80 = Acesso direto pelo IP do servidor
    environment:
      - HOMEPAGE_ALLOWED_HOSTS=*
      - TZ=${TZ:-America/Sao_Paulo}
    volumes:
      - ./configs/homepage:/app/config
      - ./configs/homepage/images:/app/public/images
      - ./configs/homepage/icons:/app/public/icons
      # Socket do Docker (necessário para o Homepage ler o status dos containers)
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # --- MONITORAMENTO (Glances) ---
  glances:
    image: nicolargo/glances:latest
    container_name: glances
    restart: unless-stopped
    pid: host
    ports:
      - "61208:61208"
    environment:
      - GLANCES_OPT=-w
      - TZ=${TZ:-America/Sao_Paulo}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # --- GERENCIADOR DE ARQUIVOS WEB (FileBrowser) ---
  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: filebrowser
    restart: unless-stopped
    ports:
      - "8085:80"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    volumes:
      - ${DATA_PATH}:/srv
      - ./configs/filebrowser/filebrowser.db:/database/filebrowser.db
  # ==========================================
  # DESENVOLVIMENTO (IA)
  # ==========================================

  # --- BACKEND DE IA (Ollama) ---
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_ORIGINS=*
    volumes:
      - ollama_data:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # --- INTERFACE (Open WebUI) ---
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "3000:8080"
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      # A chave secreta vem do .env
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY}
      - CORS_ALLOW_ORIGIN=*
    volumes:
      - open-webui_data:/app/backend/data
    depends_on:
      - ollama

  # --- ESTUDOS & VISÃO COMPUTACIONAL (Jupyter/Colab Local) ---
  colab-local:
    image: us-docker.pkg.dev/colab-images/public/runtime
    container_name: colab-local
    restart: unless-stopped
    ports:
      - "8899:8080"
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      # Os notebooks ficam organizados dentro do storage
      - ${DATA_PATH}/study:/content
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # --- GERAÇÃO DE IMAGENS (Fooocus) ---
  fooocus:
    # Apontando para a estrutura de pastas do repositório
    build: ./builds/fooocus
    container_name: fooocus
    restart: unless-stopped
    ipc: host
    ports:
      - "7865:7865"
    environment:
      - CMDARGS=--listen
      - DATADIR=/content/data
    volumes:
      # Modelos e outputs dinâmicos, isolados da configuração local do seu SO
      - ${DATA_PATH}/fooocus/models:/content/data/models
      - ${DATA_PATH}/fooocus/outputs:/content/data/outputs
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
